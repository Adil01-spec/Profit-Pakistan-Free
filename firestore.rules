/**
 * @fileOverview Firestore Security Rules for Profit Pakistan Pro.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user-specific data while allowing public read access to ads and pricing plans.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only by the user.
 * - /users/{userId}/history/{recordId}: Analysis records, accessible only by the user.
 * - /free_usage/{userId}: Free usage tracking, accessible only by the user.
 * - /plans/{planId}: Pricing plans, publicly readable.
 * - /ads/{adId}: Ad configurations, publicly readable.
 * - /proRequests/{requestId}: Manual payment submissions, create-only for clients.
 *
 * Key Security Decisions:
 * - Users can only access their own data (profiles, history, free usage).
 * - Listing of documents in user-owned subcollections is allowed only by the owner.
 * - Pricing plans and ads are publicly readable.
 * - Payment requests can be created by anyone but cannot be read, updated, or deleted by clients.
 * - No write access is granted to clients for ads or plans. These are assumed to be managed via a backend process.
 *
 * Denormalization for Authorization:
 *  - User ownership is enforced by matching the {userId} path segment with the `request.auth.uid`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creating their own profile.
     * @allow (get, update, delete) - Authenticated user accessing their own profile.
     * @deny (create, update, delete) - Any other user attempting to modify this profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      // isOwner function allows users to read and write their own profile data
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows users to read, create, update, and delete their own analysis records.
     * @path /users/{userId}/history/{recordId}
     * @allow (create) - Authenticated user creating an analysis record under their own user ID.
     * @allow (get, update, delete, list) - Authenticated user accessing their own analysis record.
     * @deny (create, update, delete, list) - Any other user attempting to modify this analysis record.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/history/{recordId} {
      // isOwner function allows users to read and write their own profile data
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows users to read and write their own free usage data.
     * @path /free_usage/{userId}
     * @allow (create) - Authenticated user creating their own free usage record.
     * @allow (get, update, delete) - Authenticated user accessing their own free usage record.
     * @deny (create, update, delete) - Any other user attempting to modify this free usage record.
     * @principle Enforces document ownership for writes.
     */
    match /free_usage/{userId} {
      // isOwner function allows users to read and write their own profile data
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows anyone to read pricing plans.
     * @path /plans/{planId}
     * @allow (get, list) - Any user, authenticated or not, can read pricing plans.
     * @deny (create, update, delete) - No one can create, update, or delete pricing plans through client-side rules.
     * @principle Publicly readable data.
     */
    match /plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read ad configurations.
     * @path /ads/{adId}
     * @allow (get, list) - Any user, authenticated or not, can read ad configurations.
     * @deny (create, update, delete) - No one can create, update, or delete ad configurations through client-side rules.
     * @principle Publicly readable data.
     */
    match /ads/{adId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to submit a payment request for manual verification.
     * @path /proRequests/{docId}
     * @allow (create) - Any user can submit a payment request.
     * @deny (get, list, update, delete) - Clients cannot read, update, or delete any payment requests.
     * @principle Write-only access for clients, managed by admins.
     */
     match /proRequests/{docId} {
        allow create: if true;
        allow get: if false;
        allow list: if false;
        allow update: if false;
        allow delete: if false;
     }
  }
}
